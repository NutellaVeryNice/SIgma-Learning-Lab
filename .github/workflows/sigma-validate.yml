name: Sigma Rules Validation

on:
  push:
    paths:
      - 'HomoglyphRelatedRules/**/*.yml'
      - 'BruteForce/**/*.yml'
      - 'DefenseEvasion/**/*.yml'
      - 'Phishing/**/*.yml'
      - 'SuspiciousFileOpen/**/*.yml'
  pull_request:
    paths:
      - 'HomoglyphRelatedRules/**/*.yml'
      - 'BruteForce/**/*.yml'
      - 'DefenseEvasion/**/*.yml'
      - 'Phishing/**/*.yml'
      - 'SuspiciousFileOpen/**/*.yml'

jobs:
  validate-sigma:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install sigma-cli
        run: |
          python3 -m pip install --upgrade pip
          pip install sigma-cli

      - name: Validate Sigma rules
        run: |
          fail_count=0
          rule_count=0
          for rule in $(find HomoglyphRelatedRules/ BruteForce/ DefenseEvasion/ Phishing/ SuspiciousFileOpen/ -name '*.yml'); do
            echo "üîç Validating $rule ..."
            if ! sigma validate "$rule"; then
              echo "‚ùå Validation failed: $rule"
              fail_count=$((fail_count+1))
            else
              echo "‚úÖ Valid: $rule"
            fi
            rule_count=$((rule_count+1))
          done

          echo "üßæ Finished validating $rule_count rule(s) with $fail_count failure(s)."

          if [ "$fail_count" -ne 0 ]; then
            exit 1
          fi
